---
title: "Software dependancy analysis"
date: "11/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
```

```{r libraries, include=FALSE}
library(tidyverse)
library(lubridate)
library(semver)
library(scales)
library(reshape)
```

## Context

Open source projects rely on libraries that get updated regularly. While not all updates require code changes, some do. 

According to [semantic versioning](https://semver.org), versions are numbered incrementally according to the type of change. A "MAJOR version" signifies incompatible API changes, a "MINOR version" signifies added functionality in a backwards compatible manner, and a "PATCH version" signifies backwards compatible bug fixes.

This project explores the number and frequency of updates in a project currently under development. It aims to shed light on the update requirements once the project will be in production.

## Methods

### Writing the data to a JSON file
The [dependency manifest file](https://github.com/canada-ca/tracker/blob/003a3d6e0452fb9a248a7d51fd5556bc03dfbcc6/frontend/package.json) from the frontend of Government of Canada's Tracker project was used as a representative example of a modern software project.

The manifest was retrieved using [curl](https://curl.se/) with the following command.
```
curl -sL "https://raw.githubusercontent.com/canada-ca/tracker/003a3d6e0452fb9a248a7d51fd5556bc03dfbcc6/frontend/package.json" > data/raw/tracker-frontend-package.json
```
### Converting the data to a CSV file
Using the following [Bash](https://www.gnu.org/software/bash/) command, package names (both development and production) were extracted from the `tracker-frontend-package.json` and details for each was retrieved from the npm API.

The command uses [jq](https://stedolan.github.io/jq) to select dependency name from the json and format the API response as CSV. Once again `curl` was used to retrieve data from the API.
```
for pkg in $(cat data/raw/tracker-frontend-package.json | jq '.dependencies * .devDependencies | keys[]' | tr -d \"); do $(curl -sL "https://registry.npmjs.org/$pkg" | jq -r --arg  name "$pkg" '.time | to_entries[] | [$name, .key, .value] | @csv' >> data/processed/nodejs.csv && sleep 1 ); done
```

The CSV contained the name of the package, the version and a time stamp.

### Cleaning the CSV file

The data needed a little attention before conducting analysis. The reader is referred to the [Rmarkdown file](https://github.com/caromimo/dependency-analysis/blob/master/index.Rmd) for code and details. 

Briefly, the data was cleaned in three main steps:

1. read the CSV file with specification for the column names;
2. removed rows that did not contain data, extracted the date from the time stamp, extracted the year as a factor, extracted the month as a factor, extracted the day of the week as a factor and parsed the version number to only include the first three numbers and the dots separating the numbers; and
3. extracted the version numbers into separate columns for major, minor and patch versions using the semver library.

```{r, include=FALSE}
library(here)
packages <- read_csv(here("data", "processed", "nodejs.csv"), col_names = c("package_name", "version", "time_stamp"))
```

```{r, include=FALSE}
data <- packages %>%
  filter(version != "created") %>%
  filter(version != "modified") %>%
  mutate(
    date = as.Date(time_stamp, "%Y/%m/%d"),
    year = as.factor(year(date)),
    month = as.factor(month(date)),
    weekday = as.factor(weekdays(date)),
    version = str_replace(version, "^(\\d{1,2}.\\d{1,2}.\\d{1,2})(\\w+)$", "\\1-\\2")
  )
```

```{r, include=FALSE}
data <- add_column(
  data,
  pull(
    data, version) %>%
    semver::parse_version() %>%
    as.data.frame() 
    ) %>%
  arrange(major, minor, patch)
```

Finally, the dataset contained 12 columns as follow: package_name, version, time_stamp, date, year, month, weekday, major, minor, patch, prerelease, and build.

```{r, include=FALSE}
colnames(data)
```

## Analysis

### Descriptive statistics

The [dependency manifest file](https://github.com/canada-ca/tracker/blob/003a3d6e0452fb9a248a7d51fd5556bc03dfbcc6/frontend/package.json) uses a total of 72 packages, which, all together, were updated through major, minor or patches in a total of 7,322 versions between December 29th 2010 to November 12th, 2020. 

Figure 1 is a plot of the number of versions for each package in this time period, with the package with the most versions on top (webpack had 681 versions) and the package with the least versions at the bottom (webpack-config-utils had six versions). Figure 1 illustrates the variation in the number of versions among packages. Note that this might be due to the creation date of packages as they did not all exist in December 2010.

```{r, fig.height=18, echo=FALSE}
data %>% 
  count(package_name, sort = TRUE) %>%
  mutate(package_name = fct_reorder(package_name, n)) %>%
  ggplot(aes(n, package_name)) +
  geom_col() +
  labs(
    title = "Figure 1: Number of versions for each package\n between December 2010 and November 2020",
    x = "Number of versions (majors, minors and patches)", 
    y = "Package name"
  ) + 
  theme_minimal()
```

Figure 2 is a heatmap of the number of versions per year per package presented in alphabetical order. The more versions in a year for a given package, the darker the color. This figure illustrates that packages have been created in every year between 2011 and 2019 and that the number of versions per package per year is highly variable. Some packages had most of their versions in the early years of their creation (e.g., babel-core), others had most versions in recent years (e.g., react) and others had no clear trends (e.g., d3). Note that at the time of writing this, the year 2020 was not complete.  

```{r, fig.height=18, echo=FALSE}
heatmap_data <- data %>% group_by(year, package_name) %>% tally()

heatmap <- heatmap_data %>% 
  ggplot(mapping = aes(x = year, y = package_name, fill = n)) +
  geom_tile() +
  labs(
    title = "Figure 2: Number of versions per year per package",
    x = "Year", 
    y = "Package name"
  ) +
  scale_fill_gradient(name = "# of versions",
                      low = "#FFFFFF",
                      high = "#012345") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

heatmap
```

Figure 3 illustrates the total number of versions per year between December 2010 and November 2020 for the packages used in the [dependency manifest file](https://github.com/canada-ca/tracker/blob/003a3d6e0452fb9a248a7d51fd5556bc03dfbcc6/frontend/package.json). Note that the years 2010 and 2020 are not complete. Between 2011 and 2019, there was an increasing number of versions per year, partially due to new packages being created. 

```{r, echo=FALSE}
# plot all versions per date
data %>%
  group_by(year) %>%
  tally() %>%
  ggplot(aes(year, n)) +
  geom_col() +
  theme_classic() +
  labs(
    title = "Figure 3: Number of versions per year between 2010 and 2020",
    x = "Year", 
    y = "Number of versions (major, minor and patches)"
  )
```

```{r, echo=FALSE}
# plot all versions per date
data %>%
  group_by(month) %>%
  tally() %>%
  ggplot(aes(month, n)) +
  geom_col() +
  theme_classic() +
  labs(
    x = "Month", 
    y = "Number of versions (major, minor and patches)"
  )
```

```{r, echo=FALSE}
# plot all versions per date
data %>%
  group_by(weekday) %>%
  tally() %>%
  ggplot(aes(weekday, n)) +
  geom_col() +
  theme_classic() +
  labs(
    x = "Weekday", 
    y = "Number of versions (major, minor and patches)"
  )
```

```{r, include=FALSE}
table <- cast(data, package_name ~ year)
table
```

